**下面是** **可直接给 Cursor / 工程师使用的指导文档** **，目标是：**

**在 ComfyUI 内部完成模板驱动的海报生成工序，并通过自定义节点实现模板选择、mask 生成、文字渲染、Logo 放置、配色等功能。**

文档以“工程说明书 + 节点规范 + 输入输出定义”的形式编写，可直接生成代码。

---

# **《ComfyUI 海报生成体系自定义节点开发文档》**

## **目标**

让 ComfyUI 成为一个**完整的海报生成流水线**，所有工序在 ComfyUI 内部完成：

1. 模板选择
2. 模板解析（文字区/视觉区/Logo区坐标）
3. Mask 生成（给 ControlNet / Inpaint 用）
4. 配色计算（从 Logo 自动生成颜色）
5. 背景生成（可用 ComfyUI 扩散部分）
6. 文字渲染
7. Logo 放置
8. 最终合成输出海报

通过以下自定义节点来实现。

---

# **目录**

1. 节点设计原则
2. 模板系统（Template）规范
3. 自定义节点列表与输入输出定义
4. 工作流建议结构（如何在 ComfyUI 中完整串联）
5. 文件组织结构建议
6. 代码实现要点（Cursor 编写时的注意事项）

---

# **1. 节点设计原则**

1. **扩散节点继续用 ComfyUI 原生节点（KSampler / ControlNet）**
2. **自定义节点只做模板相关工序** **：**

* 模板选择
* Mask 生成
* 文字渲染
* Logo 放置
* 配色

1. **每个节点职责单一、颗粒化，避免“超级大黑盒节点”**
2. 节点输入输出使用：
   * **"IMAGE"**（PIL 图像）
   * **"MASK"**（0–255 灰度）
   * **"STRING"**（JSON 字符串）
   * "INT"**, **"FLOAT"** 作为参数**
3. 所有坐标使用模板中的 **相对坐标（0～1）**，渲染时换算成像素

---

# **2. 模板（Template）规范**

模板是一个 JSON 文件（例如：**templates.json**），包含多个模板，每个模板包括：

```
{
  "id": "expo_basic_01",
  "layout": {
    "title":   { "x": 0.10, "y": 0.15, "w": 0.80, "h": 0.12, "align": "left" },
    "subtitle":{ "x": 0.10, "y": 0.28, "w": 0.80, "h": 0.08, "align": "left" },
    "time":    { "x": 0.10, "y": 0.75, "w": 0.35, "h": 0.06 },
    "booth":   { "x": 0.55, "y": 0.75, "w": 0.35, "h": 0.06 },
    "logo":    { "x": 0.10, "y": 0.86, "w": 0.20, "h": 0.08 }
  },
  "visual_blocks": [
    { "x": 0, "y": 0.15, "w": 1.0, "h": 0.5 }
  ],
  "style": {
    "default_font": "Inter",
    "title_size_ratio": 0.06,
    "subtitle_size_ratio": 0.035,
    "detail_size_ratio": 0.028
  }
}
```

---

# **3. 自定义节点列表（核心）**

以下是需要实现的自定义节点，**Cursor 依据此写代码即可**。

---

## **节点 1：**

## **PosterTemplateLoader**

### **功能**

从模板 JSON 中读取模板，并输出对应布局信息。

### **输入**

* template_id**: STRING**
* **templates_json**: STRING（包含整个 templates.json 内容）

### **输出**

* **template_layout**: STRING（该模板的 layout 字段，JSON 字符串）
* **visual_blocks**: STRING（JSON 字符串）
* **font_info**: STRING（JSON 字符串）

---

## **节点 2：**

## **PosterMaskGenerator**

### **功能**

依据模板生成主视觉 mask（白区=允许生成背景）、文字保护 mask（黑区=不能动）。

### **输入**

* **width**: INT
* height**: INT**
* **visual_blocks**: STRING（JSON 数组）

### **输出**

* visual_mask**: MASK**
* text_protect_mask**: MASK**

### **行为**

* 根据 visual_blocks 画白色矩形，其余黑色

---

## **节点 3（可选）：**

## **PosterColorEngine**

### **功能**

从 logo 图像自动提取主色，生成背景色/文字色。

### **输入**

* logo_image**: IMAGE**

### **输出**

* **bg_color**: STRING（”#RRGGBB”）
* text_main**: STRING**
* text_inverse**: STRING**

### **行为**

* KMeans 聚类，过滤噪点颜色
* 包含 WCAG 对比度检查（>4.5）

---

## **节点 4：**

## **PosterTextRenderer**

### **功能**

将文字按模板 slot 渲染到图像上。

### **输入**

* **image**: IMAGE（背景）
* template_layout**: STRING**
* 文本字段，如：
  * title_text**: STRING**
  * subtitle_text**: STRING**
  * time_text**: STRING**
  * booth_text**: STRING**
* font_path**: STRING**
* **text_color**: STRING（”#RRGGBB”）

### **输出**

* image_with_text**: IMAGE**

### **行为**

* 使用 Pillow/skia 渲染文字：
  * **坐标计算：**x_px = x_ratio * width
  * 自动换行
  * 对齐（left/center/right）
  * 超长文本缩小字体或截断

---

## **节点 5：**

## **PosterLogoPlacer**

### **功能**

按模板 slot 位置放置 Logo。

### **输入**

* **image**: IMAGE
* logo_image**: IMAGE**
* template_layout**: STRING**

### **输出**

* image_with_logo**: IMAGE**

### **行为**

* Logo 等比例缩放 → 放入 slot 内
* 支持居中/贴左/贴右

---

# **4. 推荐的 ComfyUI 工作流结构**

```
[LoadImage(logo)] → PosterColorEngine（可选）
                                     ↓
                           text_color / bg_color

LoadImage(templates.json) + template_id → PosterTemplateLoader
                             ↓             ↓
                     template_layout   visual_blocks

PosterMaskGenerator(width=1080,height=1920)
         ↓ visual_mask → ControlNet → KSampler → bg_image

bg_image + template_layout + 文案 + text_color
        ↓
PosterTextRenderer
        ↓
(image_with_text) + logo_image + template_layout
        ↓
PosterLogoPlacer
        ↓
SaveImage → Final Poster
```

整个流程：

**“背景由扩散模型生成，排版由自定义节点完成”。**

---

# **5. 文件组织结构建议**

```
custom_nodes/
    poster_nodes/
        templates.json
        template_loader.py
        mask_generator.py
        color_engine.py
        text_renderer.py
        logo_placer.py
```

---

# **6. 开发注意事项（Cursor 写代码时要遵循）**

1. 自定义节点必须继承 ComfyUI 的标准节点格式：

```
class NodeName:
    @classmethod
    def INPUT_TYPES(s):
        return { ... }
    RETURN_TYPES = (...,)
    FUNCTION = "func"
```

1. 
2. 图片处理统一用 Pillow（Comfy 内置）。
3. Mask 用 numpy/PIL 创建灰度图即可（0/255）。
4. 所有坐标必须遵守模板中定义的 0～1 比例。
5. 多文本字段可以在一个节点里一并渲染（效率更高）。
6. 输出格式需符合 Comfy 的 **"IMAGE"**、**"MASK"** 规范。

---

# **结束**

如果你把这份文档给 Cursor，它能直接开始写：

* 5 个可用的自定义节点
* 完整的可运行模板驱动海报流水线
* 完全在 ComfyUI 内部完成全部工序

你要的话，我可以继续写：

* **每个节点的****完整 Python 代码骨架**
* templates.json 的**参考模板文件**
* 整套工作流的 JSON（可直接导入 ComfyUI）
